---
const { lang = "en" } = Astro.props;
---

<section class="section-padding overflow-hidden">
	<div class="container mx-auto px-4">
		<div class="text-center mb-16 max-w-2xl mx-auto">
			<h2 class="text-3xl md:text-5xl font-bold mb-6 tracking-tight">
				{lang === 'en' ? 'Nationwide' : 'Alcance'} <span class="text-gradient">{lang === 'en' ? 'Clinical Reach' : 'Nacional'}</span>
			</h2>
			<p class="text-muted-foreground text-lg">
				{lang === 'en' 
					? 'We facilitate patient recruitment for clinical trials across all 50 states, ensuring diverse and high-quality participant enrollment.' 
					: 'Facilitamos el reclutamiento de pacientes para ensayos cl√≠nicos en los 50 estados, asegurando inscripciones diversas y de alta calidad.'}
			</p>
		</div>

		<div class="relative w-full max-w-5xl mx-auto aspect-[16/9] bg-card/50 backdrop-blur-sm rounded-3xl border border-white/5 shadow-2xl overflow-hidden p-4 md:p-8">
			<!-- D3 Map Container -->
			<div id="map-container" class="w-full h-full flex items-center justify-center">
				<svg id="us-map" class="w-full h-full max-h-[600px]"></svg>
			</div>
			
			<!-- Map Tooltip -->
			<div id="map-tooltip" class="absolute pointer-events-none opacity-0 transition-opacity duration-200 bg-black/90 text-white px-4 py-3 rounded-xl border border-white/10 shadow-xl backdrop-blur-md z-10">
				<h4 class="font-bold text-sm mb-1 uppercase tracking-wider text-primary" id="tooltip-state">State</h4>
				<p class="text-xs text-muted-foreground" id="tooltip-content">Active studies: --</p>
			</div>

			<!-- Map Controls Overlay -->
			<div class="absolute bottom-4 right-4 flex flex-col gap-2">
				<button id="zoom-in" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg border border-white/10 transition-colors" title="Zoom In">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
				<button id="zoom-out" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg border border-white/10 transition-colors" title="Zoom Out">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</button>
				<button id="zoom-reset" class="p-2 bg-white/10 hover:bg-white/20 rounded-lg border border-white/10 transition-colors" title="Reset">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
				</button>
			</div>
		</div>
	</div>
</section>

<script>
	import * as d3 from 'd3';
	import * as topojson from 'topojson-client';

	async function initMap() {
		const svg = d3.select('#us-map');
		const tooltip = d3.select('#map-tooltip');
		const container = document.getElementById('map-container');
		if (!container) return;

		const width = container.clientWidth;
		const height = container.clientHeight;

		// Create group for map paths to apply zooming
		const g = svg.append('g');

		// Set up projection
		const projection = d3.geoAlbersUsa()
			.scale(width * 1.2)
			.translate([width / 2, height / 2]);

		const path = d3.geoPath().projection(projection);

		// Zoom behavior
		const zoom = d3.zoom()
			.scaleExtent([1, 8])
			.on('zoom', (event) => {
				g.attr('transform', event.transform);
			});

		svg.call(zoom as any);

		try {
			// Fetch US TopoJSON
			const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json') as any;
			const states = topojson.feature(us, us.objects.states) as any;

			// Draw states
			g.selectAll('path')
				.data(states.features)
				.enter()
				.append('path')
				.attr('d', path)
				.attr('class', 'state-path cursor-pointer transition-colors duration-200 fill-blue-500/20 stroke-blue-500/40 hover:fill-primary/40')
				.attr('vector-effect', 'non-scaling-stroke')
				.on('mouseover', function(event, d: any) {
					d3.select(this).classed('fill-primary/60', true);
					
					tooltip.style('opacity', 1);
					
					// Update tooltip text
					document.getElementById('tooltip-state')!.textContent = d.properties.name;
					document.getElementById('tooltip-content')!.textContent = `Active studies: ${Math.floor(Math.random() * 20) + 5}`;
				})
				.on('mousemove', function(event) {
					const [x, y] = d3.pointer(event, container);
					tooltip.style('left', (x + 15) + 'px')
						.style('top', (y - 15) + 'px');
				})
				.on('mouseout', function() {
					d3.select(this).classed('fill-primary/60', false);
					tooltip.style('opacity', 0);
				});

			// Controls logic
			d3.select('#zoom-in').on('click', () => {
				svg.transition().duration(500).call(zoom.scaleBy as any, 1.5);
			});

			d3.select('#zoom-out').on('click', () => {
				svg.transition().duration(500).call(zoom.scaleBy as any, 1/1.5);
			});

			d3.select('#zoom-reset').on('click', () => {
				svg.transition().duration(500).call(zoom.transform as any, d3.zoomIdentity);
			});

		} catch (error) {
			console.error('Error loading the map:', error);
		}
	}

	// Initialize on load
	initMap();

	// Resize handling
	window.addEventListener('resize', () => {
		d3.select('#us-map g').remove();
		initMap();
	});
</script>

<style>
	.state-path {
		stroke-width: 0.5px;
	}
	
	.state-path:hover {
		stroke-width: 1px;
		stroke: white;
	}
</style>
